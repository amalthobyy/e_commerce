{% extends 'user/base.html' %}
{% load static %}
{% block content %}

<style>
  /* Ensuring buttons and dropdown align in height */
  .btn-group {
      display: flex;
      align-items: stretch;
      width: 100%;
      margin-bottom: 5px;
  }

  .btn-group .btn {
      flex-grow: 1;
      justify-content: flex-start;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 0;
      border-right: none; /* Avoid double borders */
      display: flex;
      align-items: center; /* Center content vertically */
  }

  .btn-group .dropdown-toggle {
      flex-grow: 0;
      width: auto;
      padding: 0.5rem 0.75rem;
      border-radius: 0;
      display: flex;
      align-items: center; /* Ensure dropdown arrow is vertically centered */
  }

  .form-check-input {
      margin-right: 10px;
      margin-top: 0;
      height: 1rem;
      width: 1rem; /* Ensure the checkbox is not oversized */
  }

  .dropdown-menu {
      width: 100%;
      box-sizing: border-box;
  }

  .btn-secondary:last-child {
      border-right: 1px solid #6c757d; /* Add border back on the last button */
  }

  .address-checkbox-label {
      display: flex;
      align-items: center;
      width: 100%;
      margin-bottom: 0; /* Align checkbox label and dropdown */
      padding: 0.5rem 1rem;
  }

  .address-checkbox-label input[type="checkbox"] {
      margin-right: 10px;
  }

  .card .btn-group {
      margin-bottom: 0.75rem;
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap">
      <div class="container">
          <div class="breadcrumb">
              <a href="index.html" rel="nofollow">Home</a>
              <span></span> Shop <span></span> Checkout
          </div>
      </div>
  </div>
  <section class="mt-20 mb-50">
      <div class="container">
          <div class="row">
              <div class="col-md-6">
                  <div class="mb-25">
                      <h4>Billing Details</h4>
                  </div>
                  <div class="mb-25">
                      <button class="btn btn-fill-out btn-block hover-up" 
                          style="background:black; color:white; width:100%;"
                          onclick="window.location.href='{% url 'userdash:add-addresstwo' %}'">
                          Add New Address
                      </button>
                  </div>
                  <div>
                      <div class="row">
                          <div class="col-lg-6" style="width: 700px">
                              <div class="card mb-3 mb-lg-0">
                                  {% for address in user_address %}
                                  <div class="btn-group w-100">
                                      <label class="btn btn-secondary w-100 address-checkbox-label">
                                          <input
                                              type="radio"
                                              class="form-check-input me-2 address-checkbox"
                                              id="{{ address.id }}"
                                              data-address-id="{{ address.id }}"
                                              {% if address.status %}checked{% endif %}>
                                          {{ address.name }}
                                      </label>
                                      <button
                                          class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                                          type="button"
                                          id="dropdownMenuButton{{ address.id }}"
                                          data-bs-toggle="dropdown"
                                          aria-expanded="false">
                                      </button>
                                      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ address.id }}">
                                          <li><p class="dropdown-item"><strong>House Name:</strong> {{ address.house_name }}</p></li>
                                          <li><p class="dropdown-item"><strong>Street Name:</strong> {{ address.street_name }}</p></li>
                                          <li><p class="dropdown-item"><strong>Pin Number:</strong> {{ address.pin_number }}</p></li>
                                          <li><p class="dropdown-item"><strong>District:</strong> {{ address.district }}</p></li>
                                          <li><p class="dropdown-item"><strong>State:</strong> {{ address.state }}</p></li>
                                          <li><p class="dropdown-item"><strong>Country:</strong> {{ address.country }}</p></li>
                                      </ul>
                                  </div>
                                  {% empty %}
                                  <p>No addresses found.</p>
                                  {% endfor %}
                              </div>
                          </div>
                          <br />
                      </div>
                  </div>
              </div>

              <!-- Your Orders Section -->
              <div class="col-md-6">
                  <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Your Orders</h4>
                        <div class="order-items">
                            {% for item in cart_items %}
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <img src="{{ item.variant.product.thumbnail.url }}" alt="{{ item.product.product_name }}" class="img-fluid rounded me-3" style="width: 60px; height: 60px; object-fit: cover" />
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ item.product.product_name }}</h6>
                                    <small class="text-muted">Quantity: {{ item.quantity }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="fw-bold">₹{{ item.sub_total }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="order-summary mt-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span>₹{{ cart_total }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping</span>
                                <span class="text-success">Free</span>
                            </div>
                            <div class="d-flex justify-content-between fw-bold mt-3 pt-3 border-top">
                                <span>Total</span>
                                <span>₹{{ cart_total }}</span>
                            </div>
                        </div>
                        <hr class="my-4" />
                        <form id="order-form" method="post" action="{% url 'order:place_order' %}">
                            {% csrf_token %}
                            <h5 class="mb-3">Payment Method</h5>
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="Cash On Delivery" id="CashOnDelivery" checked />
                                    <label class="form-check-label" for="CashOnDelivery">Cash On Delivery</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_option" value="Razorpay" id="Razorpay" />
                                    <label class="form-check-label" for="Razorpay">Pay with Razorpay</label>
                                </div>
                            </div>
                            <button id="place-order-button" type="submit" class="btn btn-outline-dark w-100 mt-3">Place Order</button>
                        </form>
                        
                    </div>
                  </div>
              </div>
          </div>
      </div>
  </section>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<!-- Razorpay Payment Handling -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Razorpay payment
        
        // Display messages with SweetAlert2
        {% if messages %}
            const messages = [
                {% for message in messages %}
                    {
                        type: "{{ message.tags }}",  // assuming message.tags contains the type ('success', 'error', etc.)
                        text: "{{ message }}"
                    },
                {% endfor %}
            ];
            messages.forEach(message => {
                Swal.fire({
                    toast: true,
                    position: 'top-right',
                    icon: message.type === 'error' ? 'error' : 'success',
                    title: message.text,
                    showConfirmButton: false,
                    timer: 3000,
                    background: message.type === 'error' ? '#f8d7da' : '',
                    color: message.type === 'error' ? '#721c24' : ''
                });
            });
        {% endif %}
    
        // Initialize Bootstrap dropdowns
        var dropdowns = document.querySelectorAll('.dropdown-toggle');
        dropdowns.forEach(function(dropdown) {
            new bootstrap.Dropdown(dropdown);
        });
    
        // Handle address checkbox selection and AJAX submission
        const checkboxes = document.querySelectorAll('.address-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    const addressId = this.getAttribute('data-address-id');
                    
                    fetch("{% url 'userdash:toggle_address_status' %}", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: 'address_id=' + addressId
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            checkboxes.forEach(function(otherCheckbox) {
                                if (otherCheckbox !== checkbox) {
                                    otherCheckbox.checked = false;
                                }
                            });
                        } else {
                            this.checked = false;
                            alert('Error: ' + (data.message || 'Failed to update address status.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.checked = false;
                        alert('An error occurred. Please try again.');
                    });
                }
            });
        });
    
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    
      </script>

{% endblock %}